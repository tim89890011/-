<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>诊断</title>
</head>

<body style="background:#111;color:#0f0;font-family:monospace;padding:20px">
    <h2>钢子出击 - 前端诊断</h2>
    <pre id="log">开始测试...\n</pre>
    <script src="js/config.js"></script>
    <script>
        const L = document.getElementById('log');
        function log(msg) { L.textContent += new Date().toLocaleTimeString() + ' ' + msg + '\n'; }

        // 1. Chart.js CDN 测试
        log('[1] 测试 Chart.js CDN...');
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js';
        s.onload = () => log('[1] ✅ Chart.js 加载成功');
        s.onerror = () => log('[1] ❌ Chart.js CDN 加载失败！');
        document.head.appendChild(s);

        // 2. API 直接 fetch 测试
        log('[2] 测试 fetch /api/auth/login (POST)...');
        fetch((window.API_BASE || window.location.origin) + '/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: 'a', password: '123' })
        }).then(r => {
            log('[2] ✅ 登录响应: HTTP ' + r.status);
            return r.json();
        }).then(data => {
            if (data.access_token) {
                log('[2] ✅ Token 获取成功: ' + data.access_token.substring(0, 20) + '...');
                // 3. 带 Token 请求价格
                log('[3] 测试 fetch /api/market/prices...');
                return fetch((window.API_BASE || window.location.origin) + '/api/market/prices', {
                    headers: { 'Authorization': 'Bearer ' + data.access_token }
                });
            } else {
                log('[2] ❌ 登录失败: ' + JSON.stringify(data));
            }
        }).then(r => {
            if (!r) return;
            log('[3] 价格 API 响应: HTTP ' + r.status);
            return r.json();
        }).then(data => {
            if (!data) return;
            const count = Object.keys(data.prices || {}).length;
            log('[3] ✅ 价格数据: ' + count + ' 个币种');
            if (data.prices && data.prices.BTCUSDT) {
                log('[3] BTC 价格: $' + data.prices.BTCUSDT.price);
            }
        }).catch(err => {
            log('[2/3] ❌ 网络错误: ' + err.message);
        });

        // 4. WebSocket 测试
        log('[4] 测试 WebSocket 连接...');
        try {
            const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const ws = new WebSocket(proto + '//' + (window.API_BASE || window.location.origin) + '/ws/market');
            ws.onopen = () => { log('[4] ✅ WebSocket 已连接'); ws.close(); };
            ws.onerror = () => log('[4] ❌ WebSocket 连接失败');
        } catch (e) { log('[4] ❌ WebSocket 异常: ' + e.message); }

        // 5. localStorage 测试
        log('[5] localStorage 测试...');
        try {
            localStorage.setItem('__test__', '1');
            localStorage.removeItem('__test__');
            const token = localStorage.getItem('gangzi_token');
            log('[5] ✅ localStorage 可用, 已存token: ' + (token ? '有(' + token.substring(0, 15) + '...)' : '无'));
        } catch (e) { log('[5] ❌ localStorage 不可用: ' + e.message); }

        log('---诊断完成---');
    </script>
</body>

</html>