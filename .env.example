# ============================================
# 钢子出击 - 配置文件
# 复制此文件为 .env 并填写真实值
# ============================================

# DeepSeek API 配置
DEEPSEEK_API_KEY=
DEEPSEEK_API_KEY_FILE=./secrets/deepseek_api_key
DEEPSEEK_BASE_URL=https://api.deepseek.com

# 千问（Qwen3-Max / DashScope OpenAI 兼容）配置
# 中国大陆（推荐）：https://dashscope.aliyuncs.com/compatible-mode/v1
QWEN_API_KEY=
QWEN_API_KEY_FILE=./secrets/qwen_api_key
QWEN_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1

# JWT 认证密钥（随机字符串，务必修改）
JWT_SECRET=change_this_to_random_string
JWT_ALGORITHM=HS256
JWT_ACCESS_EXPIRE_MINUTES=30
JWT_REFRESH_EXPIRE_DAYS=7

# 数据库路径
DATABASE_URL=sqlite+aiosqlite:///./data/gangzi.db

# 管理员账号（首次启动自动创建）
ADMIN_USERNAME=admin
ADMIN_PASSWORD=change_this_admin_password
ENABLE_PUBLIC_REGISTER=false
# 安全策略：密码重置必须管理员审批（不在 API 响应中返回 token）
RESET_REQUIRE_ADMIN_APPROVAL=true
# 可信反代 IP 白名单（逗号分隔）。仅这些来源才信任 X-Forwarded-For
TRUSTED_PROXY_IPS=127.0.0.1
# 安全逃生门（生产环境必须全部为 false）
ALLOW_WEAK_ADMIN_PASSWORD=false
ALLOW_DEFAULT_JWT_SECRET=false
ALLOW_PLAINTEXT_API_KEYS=false

# 服务器配置
HOST=0.0.0.0
PORT=9998

# Telegram Bot（留空则不启用）
TG_BOT_TOKEN=
TG_CHAT_ID=

# Telegram 重试/队列（可选，有默认值）
# TG_MAX_RETRIES=3          # 发送失败最大重试次数
# TG_RETRY_BASE_DELAY=1.0   # 重试基础延迟（秒）
# TG_ENABLE_QUEUE=true       # 启用消息队列
# TG_QUEUE_MAX_SIZE=100      # 队列最大消息数
# TG_RATE_LIMIT=30           # 每秒最大发送数
# TG_LOG_SUCCESS=false       # 是否记录成功发送日志

# CORS 和代理（可选）
# ALLOWED_ORIGIN=*           # 允许的 CORS 来源（生产环境应限制）

# API Key 加密（建议生产环境配置）
# ENCRYPTION_KEY=            # Fernet 加密密钥（留空则明文存储 API Key）
# ENCRYPTION_KEY_FILE=       # 或从文件读取加密密钥
# FORCE_ENCRYPTION=false     # 强制要求加密（true 时无密钥会拒绝启动）

# ============================================
# 自动交易配置（币安模拟盘）
# ============================================

# 总开关（改为 true 才会启用自动交易）
TRADE_ENABLED=false

# 币安合约测试网 API Key（在 https://testnet.binancefuture.com/ 创建）
BINANCE_TESTNET_API_KEY=
BINANCE_TESTNET_API_SECRET=

# 合约杠杆倍数（默认3x）
TRADE_LEVERAGE=3
# 保证金模式：isolated(逐仓) / cross(全仓)
TRADE_MARGIN_MODE=isolated

# === 仓位管理 ===
# 每次开仓保证金（USDT）- 作为百分比模式的兜底上限
TRADE_AMOUNT_USDT=100
# 每次开仓保证金占可用余额百分比（设0则用固定值）
# 例: 5% × 10000 USDT = 500 USDT 保证金 → 1500 USDT 名义价值(3x)
TRADE_AMOUNT_PCT=5.0
#
# 想“只按比例，不要固定上限”：
# - 设置 TRADE_AMOUNT_USDT=0
# - 用 TRADE_AMOUNT_PCT 控制单笔仓位比例
# 单币种最大持仓名义价值兜底上限（USDT）
TRADE_MAX_POSITION_USDT=500
# 单币种最大持仓占账户总资金百分比（设0则用固定值）
# 例: 30% × 10000 USDT = 3000 USDT 名义价值上限
TRADE_MAX_POSITION_PCT=30.0

# 允许自动交易的币种（逗号分隔）
TRADE_SYMBOLS=BTCUSDT,ETHUSDT

# 全局最低置信度（兜底值）
TRADE_MIN_CONFIDENCE=60
# 分类型置信度门槛（BUY准确率高可放宽，SELL准确率低需收紧）
TRADE_MIN_CONF_BUY=60
TRADE_MIN_CONF_SHORT=70
TRADE_MIN_CONF_SELL=80

# 反向翻仓所需最低置信度
# TRADE_FLIP_CONFIDENCE=85

# BUY/SHORT 开仓冷却时间（秒），默认5分钟
TRADE_COOLDOWN_SECONDS=300

# 开仓后最短持仓时间（秒）：未到不允许 SELL/COVER/止盈/移动止盈，仅允许止损
TRADE_MIN_HOLD_SECONDS=300

# 每日交易限额（USDT），超过后当天不再开仓
TRADE_DAILY_LIMIT_USDT=1000

# 资金利用率上限（%）：只动用可用余额的 N%，留 (100-N)% 备用（建议 70-90）
TRADE_BALANCE_UTILIZATION_PCT=80

# === 止盈止损（价格维度，3x杠杆下保证金盈亏 = 价格变动 × 3） ===
# 止盈: 价格涨4% → 保证金收益约12%
TRADE_TAKE_PROFIT_PCT=4.0
# 止损: 价格跌2% → 保证金亏损约6%
TRADE_STOP_LOSS_PCT=2.0
# 是否启用移动止盈（4级递进：≥1.5%小亏保护 → ≥2%保本 → ≥2.5%锁+0.8% → ≥3.5%锁+2%）
TRADE_TRAILING_STOP_ENABLED=true
# 持仓超时（小时）：硬超时=此值且亏损→强平，弱超时=12h且利润<0.5%→平仓（0=禁用）
TRADE_POSITION_TIMEOUT_HOURS=24

# ============================================
# RiskGate 风控熔断 & 降级
# ============================================

# --- 基础熔断（触发→信号改 HOLD）---
RISK_MAX_DAILY_DRAWDOWN_PCT=5.0
RISK_MAX_CONSECUTIVE_INCORRECT=5

# --- 波动率尖峰降级（触发→置信度下调，信号方向不变）---
# ATR 尖峰倍率：当前 ATR > 滚动均值 × 此值时触发（0=禁用，推荐 2.0）
RISK_ATR_SPIKE_MULTIPLIER=2.0
# 尖峰触发时置信度下调幅度（绝对值 %）
RISK_ATR_SPIKE_CONFIDENCE_REDUCTION=30.0
# ATR 滚动窗口大小（需积累足够样本后才开始检测）
RISK_ATR_HISTORY_WINDOW=20

# --- 相关性暴露检查（触发→置信度下调）---
# 需检查的相关币种（逗号分隔，留空=禁用）
RISK_CORRELATED_SYMBOLS=BTCUSDT,ETHUSDT
# 相关币种同方向总暴露上限（占账户权益 %）
RISK_MAX_CORRELATED_EXPOSURE_PCT=50.0
# 相关性暴露触发时置信度下调幅度（绝对值 %）
RISK_CORRELATED_EXPOSURE_CONFIDENCE_REDUCTION=20.0

# ============================================
# API 配额与成本配置
# ============================================

# 配额限制（建议：分析型系统每日约需 8000-10000 次调用）
ENABLE_QUOTA_LIMIT=true
DAILY_API_QUOTA=10000
QUOTA_WARNING_THRESHOLD=0.8
QUOTA_CRITICAL_THRESHOLD=0.9

# DeepSeek API 成本配置（元/千 token）
# Chat V3: 输入 0.001, 输出 0.002
# Reasoner R1: 输入 0.003, 输出 0.006
DEEPSEEK_CHAT_COST_PER_1K=0.001
DEEPSEEK_R1_COST_PER_1K=0.003
